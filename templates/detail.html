<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ê³µì—° ìƒì„¸ì •ë³´</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="container" id="captureArea">
        <a href="/?date={{ date }}" class="back-button" id="backButton">â† ëª©ë¡ìœ¼ë¡œ</a>
        <h1>{{ detail.title }}</h1>
        <!-- proxy_image ë¼ìš°íŠ¸ ê²½ìœ í•´ì„œ ì´ë¯¸ì§€ ìš°íšŒ ìš”ì²­ -->
        <img id="poster" src="/proxy_image?url={{ detail.poster }}" alt="{{ detail.title }}" crossorigin="anonymous" />
        <div class="detail-info">
            <p><strong>ì¥ë¥´:</strong> {{ detail.genre }}</p>
            <p><strong>ê³µì—°ê¸°ê°„:</strong> {{ detail.start_date }} ~ {{ detail.end_date }}</p>
            <p><strong>ê³µì—°ì¥ì†Œ:</strong> {{ detail.place }}</p>
            <p><strong>ì£¼ì†Œ:</strong> <span id="address-text">{{ detail.address }}</span></p>
            <p><strong>ê³µì—°ì‹œê°„:</strong> {{ detail.runtime }}</p>
            <p><strong>ê´€ëŒì—°ë ¹:</strong> {{ detail.age }}</p>
            <p><strong>í‹°ì¼“ê°€ê²©:</strong> {{ detail.price }}</p>
            <p><strong>ì¶œì—°ì§„:</strong> {{ detail.cast }}</p>
        </div>

        <div class="map-section" data-html2canvas-ignore="true">
            <h3>ìœ„ì¹˜</h3>
            <div id="map" style="width:100%;height:350px;"></div>
            <p id="map-status" style="display:none; text-align:center; color:#e74c3c; margin-top:10px; font-size:14px;"></p>
        </div>

        <div class="share-section" id="shareSection">
            <h3>ê³µìœ í•˜ê¸°</h3>
            <div class="share-buttons">
                <button onclick="captureAndSave()" class="share-btn save-btn" id="saveBtn">ğŸ’¾ í˜ì´ì§€ ì €ì¥</button>
                <button onclick="shareGoogleMail()" class="share-btn google-btn">G êµ¬ê¸€ ë©”ì¼</button>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a4f66e6d611ca7253dafc7e524bccae4&libraries=services"></script>
    <script>
        const detailData = {
            id: '{{ detail.id }}',
            title: '{{ detail.title }}',
            start_date: '{{ detail.start_date }}',
            end_date: '{{ detail.end_date }}',
            place: '{{ detail.place }}',
            poster: '{{ detail.poster }}',
            genre: '{{ detail.genre }}',
            runtime: '{{ detail.runtime }}',
            age: '{{ detail.age }}',
            cast: '{{ detail.cast }}',
            address: '{{ detail.address }}',
            price: '{{ detail.price }}'
        };

        // ì´ë©”ì¼ ê³µìœ  í•¨ìˆ˜
        function shareGoogleMail() {
            const subject = `[ê³µì—° ì •ë³´] ${detailData.title}`;
            const body = `
ì•ˆë…•í•˜ì„¸ìš”, ê³µì—° ì •ë³´ë¥¼ ê³µìœ í•©ë‹ˆë‹¤.

[${detailData.title}]
â–¶ í¬ìŠ¤í„° ë§í¬: ${detailData.poster}

- ì¥ë¥´: ${detailData.genre}
- ê¸°ê°„: ${detailData.start_date} ~ ${detailData.end_date}
- ì¥ì†Œ: ${detailData.place}
- ì£¼ì†Œ: ${detailData.address}
- ì‹œê°„: ${detailData.runtime}
- ì—°ë ¹: ${detailData.age}
- í‹°ì¼“: ${detailData.price}
- ì¶œì—°: ${detailData.cast}

*ì§€ë„ ì´ë¯¸ì§€ëŠ” í¬í•¨í•˜ì§€ ì•Šê³ , ì£¼ì†Œë¥¼ ì°¸ê³ í•´ ì£¼ì„¸ìš”.*

ìì„¸í•œ ë‚´ìš©ì€ ì˜ˆë§¤ ì‚¬ì´íŠ¸ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.
            `.trim();

            const url = `https://mail.google.com/mail/?view=cm&fs=1&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(url, '_blank', 'width=800,height=600');
        }

        // ìº¡ì²˜ ë° ì €ì¥ í•¨ìˆ˜ (ì§€ë„ ì˜ì—­ ì œì™¸)
        async function captureAndSave() {
            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.innerHTML;

            try {
                saveBtn.innerHTML = 'ğŸ’¾ ì €ì¥ ì¤‘...';
                saveBtn.disabled = true;

                document.getElementById('shareSection').style.visibility = 'hidden';
                document.getElementById('backButton').style.visibility = 'hidden';

                await new Promise(resolve => setTimeout(resolve, 300));

                const canvas = await html2canvas(document.getElementById('captureArea'), {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: false,
                    removeContainer: true,
                    ignoreElements: element => element.hasAttribute('data-html2canvas-ignore')
                });

                document.getElementById('shareSection').style.visibility = 'visible';
                document.getElementById('backButton').style.visibility = 'visible';

                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;

                const imageData = canvas.toDataURL('image/png', 1.0);

                const response = await fetch('/save_screenshot', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        image_data: imageData,
                        title: detailData.title
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (err) {
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
                document.getElementById('shareSection').style.visibility = 'visible';
                document.getElementById('backButton').style.visibility = 'visible';
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        // ì¹´ì¹´ì˜¤ ì§€ë„ ì„¤ì • ë° í‘œì‹œ
        if (typeof kakao === 'undefined') {
            const statusEl = document.getElementById('map-status');
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<strong style="font-size:16px;">âš ï¸ ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</strong><br><span>API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</span>';
        } else {
            const mapContainer = document.getElementById('map');
            const mapOption = { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 3 };
            const map = new kakao.maps.Map(mapContainer, mapOption);
            const geocoder = new kakao.maps.services.Geocoder();

            let address = '{{ detail.address }}';
            let placeName = '{{ detail.place }}';
            let searchKeyword = address && address !== 'ì •ë³´ ì—†ìŒ' && address !== 'None' ? address : placeName;

            const statusEl = document.getElementById('map-status');
            statusEl.style.display = 'block';
            statusEl.textContent = 'ìœ„ì¹˜ ê²€ìƒ‰ ì¤‘...';

            geocoder.addressSearch(searchKeyword, (result, status) => {
                if (status === kakao.maps.services.Status.OK) {
                    const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                    new kakao.maps.Marker({ map, position: coords });
                    map.setCenter(coords);
                    statusEl.style.display = 'none';
                } else {
                    const ps = new kakao.maps.services.Places();
                    ps.keywordSearch(searchKeyword, (data, status) => {
                        if (status === kakao.maps.services.Status.OK) {
                            const coords = new kakao.maps.LatLng(data[0].y, data[0].x);
                            new kakao.maps.Marker({ map, position: coords });
                            map.setCenter(coords);
                            statusEl.style.display = 'none';
                            document.getElementById('address-text').textContent = data[0].address_name || '{{ detail.address }}';
                        } else {
                            statusEl.style.display = 'block';
                            statusEl.innerHTML = `<strong style="font-size:16px;">âš ï¸ ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</strong><br><span>ê²€ìƒ‰ì–´: ${searchKeyword}</span>`;
                        }
                    });
                }
            });
        }
    </script>
</body>
</html>
